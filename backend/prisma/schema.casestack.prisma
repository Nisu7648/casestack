// ============================================
// CASESTACK - FINALIZATION & DEFENSIBILITY SYSTEM
// Database Schema (Locked Direction)
// WITH DEVICE SESSION MANAGEMENT (MAX 3 DEVICES)
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// FIRM & USER MANAGEMENT
// ============================================

model Firm {
  id        String   @id @default(cuid())
  name      String
  industry  String?
  country   String   // India, Europe, Switzerland (affects pricing)
  
  // Licensing
  licenseType      String   @default("ENTERPRISE") // ENTERPRISE only
  seatsLicensed    Int      @default(0)
  seatsUsed        Int      @default(0)
  pricePerSeat     Decimal  @db.Decimal(10, 2)
  billingCurrency  String   @default("INR") // INR, EUR, CHF, USD
  
  users         User[]
  clients       Client[]
  cases         Case[]
  settings      FirmSettings?
  subscriptions Subscription[]
  auditLogs     AuditLog[]
  memoryIndex   FirmMemoryIndex[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([name])
}

model FirmSettings {
  id     String @id @default(cuid())
  firmId String @unique
  firm   Firm   @relation(fields: [firmId], references: [id], onDelete: Cascade)
  
  // Approval Rules
  requirePartnerForFinalization Boolean @default(true)
  requireTwoApprovers           Boolean @default(false)
  
  // Security
  enableDownloadTracking Boolean @default(true)
  enableAuditExport      Boolean @default(true)
  maxDevicesPerUser      Int     @default(3) // NEW: Maximum devices per user
  
  // Archival
  autoArchiveAfterYears Int @default(7)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UserRole {
  ADMIN      // Firm admin
  PARTNER    // Can finalize cases
  MANAGER    // Can review cases (Reviewer)
  CONSULTANT // Can prepare cases
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  
  firstName String
  lastName  String
  role      UserRole
  
  firmId    String
  firm      Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)
  
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  
  // Cases
  preparedCases  Case[] @relation("PreparedBy")
  reviewedCases  Case[] @relation("ReviewedBy")
  approvedCases  Case[] @relation("ApprovedBy")
  
  // Device Sessions (NEW)
  deviceSessions DeviceSession[]
  
  // Logs
  auditLogs      AuditLog[]
  downloadLogs   DownloadLog[]
  approvalChains ApprovalChain[]
  uploadedFiles  CaseFile[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([email])
  @@index([firmId, role])
}

// ============================================
// DEVICE SESSION MANAGEMENT (NEW)
// Maximum 3 active devices per user
// ============================================

model DeviceSession {
  id String @id @default(cuid())
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Device Information
  deviceId          String   // Unique device identifier (generated on first login)
  deviceName        String?  // "Chrome on Windows", "Safari on iPhone"
  deviceType        String?  // "desktop", "mobile", "tablet"
  browser           String?  // "Chrome", "Safari", "Firefox"
  os                String?  // "Windows", "macOS", "iOS", "Android"
  
  // Session Information
  token             String   @unique // JWT token
  refreshToken      String?  @unique // For token refresh
  ipAddress         String?
  userAgent         String?
  
  // Status
  isActive          Boolean  @default(true)
  lastActivityAt    DateTime @default(now())
  expiresAt         DateTime
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId, isActive])
  @@index([token])
  @@index([deviceId])
  @@index([expiresAt])
}

// ============================================
// BILLING & LICENSE MODULE
// ============================================

enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

model Subscription {
  id String @id @default(cuid())
  
  firmId String
  firm   Firm   @relation(fields: [firmId], references: [id], onDelete: Cascade)
  
  pricePerUser   Decimal            @db.Decimal(10, 2)
  currency       String             // INR, EUR, CHF, USD
  billingCycle   String             @default("MONTHLY") // MONTHLY, ANNUAL
  activeUsers    Int                @default(0)
  status         SubscriptionStatus @default(ACTIVE)
  
  startDate DateTime @default(now())
  endDate   DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([firmId, status])
}

// ============================================
// CLIENT MANAGEMENT (MINIMAL)
// ============================================

model Client {
  id       String  @id @default(cuid())
  name     String
  industry String?
  
  firmId String
  firm   Firm   @relation(fields: [firmId], references: [id], onDelete: Cascade)
  
  cases Case[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([firmId, name])
}

// ============================================
// CASE MANAGEMENT MODULE (CORE)
// ============================================

enum CaseStatus {
  DRAFT          // Being prepared
  UNDER_REVIEW   // Submitted for review
  FINALIZED      // LOCKED - Cannot be changed
}

enum CaseType {
  AUDIT
  CONSULTING
  TAX
  ADVISORY
  DUE_DILIGENCE
  RISK_ASSESSMENT
}

model Case {
  id          String     @id @default(cuid())
  caseNumber  String     @unique // Auto-generated: CASE-2024-001
  caseName    String
  caseType    CaseType
  
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Restrict)
  
  firmId String
  firm   Firm   @relation(fields: [firmId], references: [id], onDelete: Cascade)
  
  // Period
  periodStart DateTime
  periodEnd   DateTime
  fiscalYear  Int
  
  // Status
  status CaseStatus @default(DRAFT)
  
  // Responsibility Chain
  preparedById String
  preparedBy   User   @relation("PreparedBy", fields: [preparedById], references: [id], onDelete: Restrict)
  
  reviewedById String?
  reviewedBy   User?   @relation("ReviewedBy", fields: [reviewedById], references: [id], onDelete: Restrict)
  
  approvedById String?
  approvedBy   User?   @relation("ApprovedBy", fields: [approvedById], references: [id], onDelete: Restrict)
  
  // Timestamps
  submittedForReviewAt DateTime?
  finalizedAt          DateTime?
  
  // Locking
  isLocked     Boolean @default(false)
  lockedAt     DateTime?
  lockedReason String? // "FINALIZED", "REGULATORY", "LEGAL"
  
  // Files
  bundles      CaseBundle[]
  
  // Metadata
  description  String?
  tags         String[] // For search
  
  // Logs
  auditLogs      AuditLog[]
  downloadLogs   DownloadLog[]
  approvalChains ApprovalChain[]
  memoryIndex    FirmMemoryIndex[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([firmId, status])
  @@index([clientId])
  @@index([caseNumber])
  @@index([fiscalYear])
  @@index([finalizedAt])
}

// ============================================
// FILE BUNDLE MODULE
// ============================================

model CaseBundle {
  id          String @id @default(cuid())
  bundleName  String // "Final Report Package", "Supporting Documents"
  version     Int    @default(1)
  
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  // Files
  files CaseFile[]
  
  // Finalization
  isFinalized  Boolean   @default(false)
  finalizedAt  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([caseId])
}

enum FileType {
  PDF
  XLSX
  DOCX
  ZIP
  OTHER
}

model CaseFile {
  id       String   @id @default(cuid())
  fileName String
  fileType FileType
  fileSize Int      // bytes
  fileHash String   // SHA-256 for integrity verification
  
  bundleId String
  bundle   CaseBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  // Storage
  storageUrl  String // S3 URL or local path
  storagePath String // For local storage
  
  // Upload Info
  uploadedById String
  uploadedBy   User   @relation(fields: [uploadedById], references: [id], onDelete: Restrict)
  
  // Locking
  isLocked Boolean   @default(false)
  lockedAt DateTime?
  
  createdAt DateTime @default(now())
  
  @@index([bundleId])
  @@index([fileHash])
}

// ============================================
// APPROVAL CHAIN MODULE
// ============================================

enum ApprovalAction {
  SUBMITTED_FOR_REVIEW
  REVIEWED
  REJECTED
  FINALIZED
}

model ApprovalChain {
  id String @id @default(cuid())
  
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  action      ApprovalAction
  actionById  String
  actionBy    User           @relation(fields: [actionById], references: [id], onDelete: Restrict)
  
  comments String?
  
  createdAt DateTime @default(now())
  
  @@index([caseId])
}

// ============================================
// AUDIT LOG MODULE (IMMUTABLE)
// ============================================

enum AuditAction {
  // Auth
  USER_LOGIN
  USER_LOGOUT
  USER_CREATED
  USER_UPDATED
  USER_DEACTIVATED
  
  // Device Sessions (NEW)
  DEVICE_REGISTERED
  DEVICE_REMOVED
  DEVICE_LIMIT_EXCEEDED
  
  // Cases
  CASE_CREATED
  CASE_UPDATED
  CASE_VIEWED
  CASE_SUBMITTED
  CASE_REVIEWED
  CASE_FINALIZED
  
  // Files
  FILE_UPLOADED
  FILE_DOWNLOADED
  FILE_DELETED
  BUNDLE_CREATED
  BUNDLE_DOWNLOADED
  
  // Settings
  SETTINGS_UPDATED
}

model AuditLog {
  id String @id @default(cuid())
  
  firmId String
  firm   Firm   @relation(fields: [firmId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)
  
  action       AuditAction
  resourceType String      // "CASE", "FILE", "USER", "DEVICE"
  resourceId   String?
  
  caseId String?
  case   Case?   @relation(fields: [caseId], references: [id], onDelete: SetNull)
  
  metadata Json? // Additional context
  
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())
  
  @@index([firmId, createdAt])
  @@index([userId])
  @@index([caseId])
  @@index([action])
}

// ============================================
// DOWNLOAD TRACKING MODULE
// ============================================

enum DownloadType {
  SINGLE_FILE
  FULL_BUNDLE
  CASE_EXPORT
}

model DownloadLog {
  id String @id @default(cuid())
  
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)
  
  downloadType DownloadType
  fileIds      String[] // Array of file IDs downloaded
  
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())
  
  @@index([caseId])
  @@index([userId])
}

// ============================================
// FIRM MEMORY INDEX (SEARCH)
// ============================================

model FirmMemoryIndex {
  id String @id @default(cuid())
  
  firmId String
  firm   Firm   @relation(fields: [firmId], references: [id], onDelete: Cascade)
  
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  // Searchable Fields
  clientName   String
  caseName     String
  caseType     String
  fiscalYear   Int
  partnerName  String
  searchVector String // Full-text search
  
  finalizedAt DateTime
  
  createdAt DateTime @default(now())
  
  @@index([firmId, fiscalYear])
  @@index([searchVector])
}
