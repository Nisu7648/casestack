// Prisma Schema - Complete CaseStack Platform
// Modules: Foundation, Case Canvas, Workflows, Analytics

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MODULE 0: FOUNDATION
// ============================================

model Firm {
  id        String   @id @default(uuid())
  name      String
  country   String
  billingEnabled Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  users     User[]
  activityLogs ActivityLog[]
  clients   Client[]
  cases     Case[]
  workflowTemplates WorkflowTemplate[]
  
  @@map("firms")
}

enum UserRole {
  ADMIN
  PARTNER
  MANAGER
  CONSULTANT
  VIEWER
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(CONSULTANT)
  isActive  Boolean  @default(true)
  
  firmId    String
  firm      Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?
  
  activityLogs ActivityLog[]
  casesLead    Case[]        @relation("CaseLead")
  caseMembers  CaseMember[]
  tasks        Task[]
  timeEntries  TimeEntry[]
  caseActivities CaseActivity[]
  activityMentions CaseActivity[] @relation("ActivityMentions")
  comments     Comment[]
  documentsUploaded Document[]
  milestones   Milestone[]
  risks        Risk[]
  
  @@index([firmId])
  @@index([email])
  @@map("users")
}

enum ActivityAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  LOGIN
  LOGOUT
  PERMISSION_CHANGE
}

model ActivityLog {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userEmail String
  userName  String
  userRole  UserRole
  
  action    ActivityAction
  entity    String
  entityId  String?
  details   String?
  
  timestamp DateTime @default(now())
  
  firmId    String
  firm      Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)
  ipAddress String?
  userAgent String?
  
  @@index([userId])
  @@index([firmId])
  @@index([timestamp])
  @@index([entity, entityId])
  @@map("activity_logs")
}

// ============================================
// MODULE 1: CASE CANVAS
// ============================================

model Client {
  id          String   @id @default(uuid())
  name        String
  industry    String?
  country     String?
  website     String?
  
  contactName  String?
  contactEmail String?
  contactPhone String?
  
  address     String?
  city        String?
  state       String?
  postalCode  String?
  
  notes       String?
  
  firmId      String
  firm        Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)
  
  cases       Case[]
  contacts    Contact[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([firmId])
  @@index([name])
  @@map("clients")
}

model Contact {
  id          String   @id @default(uuid())
  
  firstName   String
  lastName    String
  email       String?
  phone       String?
  position    String?
  isPrimary   Boolean  @default(false)
  
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([clientId])
  @@map("contacts")
}

enum CaseType {
  STRATEGY
  OPERATIONS
  TECHNOLOGY
  FINANCIAL
  HR
  MARKETING
  SALES
  LEGAL
  OTHER
}

enum CaseStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  REVIEW
  COMPLETED
  CANCELLED
}

enum CasePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Case {
  id          String   @id @default(uuid())
  
  title       String
  description String?
  caseNumber  String   @unique
  caseType    CaseType
  status      CaseStatus @default(PLANNING)
  priority    CasePriority @default(MEDIUM)
  
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Restrict)
  
  startDate   DateTime
  endDate     DateTime
  
  budgetTotal    Decimal  @default(0)
  budgetSpent    Decimal  @default(0)
  currency       String   @default("USD")
  hourlyRate     Decimal?
  
  leadId      String
  lead        User     @relation("CaseLead", fields: [leadId], references: [id], onDelete: Restrict)
  members     CaseMember[]
  
  progressPercentage Int @default(0)
  
  firmId      String
  firm        Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)
  
  tasks       Task[]
  timeEntries TimeEntry[]
  documents   Document[]
  activities  CaseActivity[]
  milestones  Milestone[]
  risks       Risk[]
  dependencies Dependency[]
  customFields CustomFieldValue[]
  
  tags        String[]
  isArchived  Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([firmId])
  @@index([clientId])
  @@index([status])
  @@index([leadId])
  @@index([caseNumber])
  @@map("cases")
}

model CaseMember {
  id          String   @id @default(uuid())
  
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role        String?
  
  joinedAt    DateTime @default(now())
  
  @@unique([caseId, userId])
  @@index([caseId])
  @@index([userId])
  @@map("case_members")
}

enum TaskType {
  TASK
  DELIVERABLE
  MILESTONE
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  REVIEW
  BLOCKED
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id          String   @id @default(uuid())
  
  title       String
  description String?
  type        TaskType @default(TASK)
  status      TaskStatus @default(NOT_STARTED)
  priority    TaskPriority @default(MEDIUM)
  
  assigneeId  String?
  assignee    User?    @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  
  dueDate     DateTime?
  startDate   DateTime?
  completedAt DateTime?
  
  estimatedHours Decimal?
  actualHours    Decimal  @default(0)
  
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  deliverableType String?
  version         Int     @default(1)
  clientApproved  Boolean @default(false)
  
  timeEntries TimeEntry[]
  comments    Comment[]
  dependencies Dependency[] @relation("DependentTask")
  blockedBy    Dependency[] @relation("BlockingTask")
  subtasks    Task[]  @relation("ParentTask")
  parentTaskId String?
  parentTask  Task?   @relation("ParentTask", fields: [parentTaskId], references: [id], onDelete: Cascade)
  
  order       Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([caseId])
  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
  @@index([parentTaskId])
  @@map("tasks")
}

model TimeEntry {
  id          String   @id @default(uuid())
  
  startTime   DateTime
  endTime     DateTime?
  duration    Decimal
  description String?
  
  billable    Boolean  @default(true)
  hourlyRate  Decimal?
  amount      Decimal?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([caseId])
  @@index([taskId])
  @@index([startTime])
  @@map("time_entries")
}

enum DocumentType {
  PROPOSAL
  CONTRACT
  REPORT
  PRESENTATION
  SPREADSHEET
  IMAGE
  OTHER
}

model Document {
  id          String   @id @default(uuid())
  
  name        String
  description String?
  type        DocumentType @default(OTHER)
  
  fileName    String
  fileSize    Int
  mimeType    String
  fileUrl     String
  
  version     Int      @default(1)
  
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  uploadedById String
  uploadedBy   User    @relation(fields: [uploadedById], references: [id], onDelete: Restrict)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([caseId])
  @@index([uploadedById])
  @@map("documents")
}

enum CaseActivityAction {
  CREATED
  UPDATED
  COMPLETED
  COMMENTED
  UPLOADED
  DELETED
  MENTIONED
  STATUS_CHANGED
  MEMBER_ADDED
  MEMBER_REMOVED
}

model CaseActivity {
  id          String   @id @default(uuid())
  
  action      CaseActivityAction
  entity      String
  entityId    String?
  description String
  metadata    String?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  mentions    User[]   @relation("ActivityMentions")
  
  timestamp   DateTime @default(now())
  
  @@index([caseId])
  @@index([timestamp])
  @@index([userId])
  @@map("case_activities")
}

model Comment {
  id          String   @id @default(uuid())
  
  content     String
  
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([taskId])
  @@index([userId])
  @@map("comments")
}

// ============================================
// MODULE 2: ADVANCED FEATURES
// ============================================

// Milestones (like Excel project tracking)
enum MilestoneStatus {
  UPCOMING
  IN_PROGRESS
  COMPLETED
  DELAYED
}

model Milestone {
  id          String   @id @default(uuid())
  
  title       String
  description String?
  dueDate     DateTime
  completedAt DateTime?
  status      MilestoneStatus @default(UPCOMING)
  
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Restrict)
  
  order       Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([caseId])
  @@index([dueDate])
  @@map("milestones")
}

// Risk Register (Excel-style risk tracking)
enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskStatus {
  IDENTIFIED
  ASSESSING
  MITIGATING
  MONITORING
  CLOSED
}

model Risk {
  id          String   @id @default(uuid())
  
  title       String
  description String
  category    String?
  
  probability RiskLevel
  impact      RiskLevel
  riskScore   Int // Calculated: probability * impact
  
  status      RiskStatus @default(IDENTIFIED)
  
  mitigation  String?
  contingency String?
  
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Restrict)
  
  identifiedAt DateTime @default(now())
  closedAt     DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([caseId])
  @@index([status])
  @@index([riskScore])
  @@map("risks")
}

// Task Dependencies (Gantt chart style)
enum DependencyType {
  FINISH_TO_START
  START_TO_START
  FINISH_TO_FINISH
  START_TO_FINISH
}

model Dependency {
  id          String   @id @default(uuid())
  
  type        DependencyType @default(FINISH_TO_START)
  lagDays     Int      @default(0) // Delay between tasks
  
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  dependentTaskId String
  dependentTask   Task   @relation("DependentTask", fields: [dependentTaskId], references: [id], onDelete: Cascade)
  
  blockingTaskId  String
  blockingTask    Task   @relation("BlockingTask", fields: [blockingTaskId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@unique([dependentTaskId, blockingTaskId])
  @@index([caseId])
  @@map("dependencies")
}

// Workflow Templates (Notion-style templates)
model WorkflowTemplate {
  id          String   @id @default(uuid())
  
  name        String
  description String?
  caseType    CaseType
  
  isPublic    Boolean  @default(false)
  
  firmId      String
  firm        Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)
  
  templateData String // JSON: tasks, milestones, dependencies
  
  usageCount  Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([firmId])
  @@index([caseType])
  @@map("workflow_templates")
}

// Custom Fields (Excel-style custom columns)
enum FieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  MULTISELECT
  CHECKBOX
  URL
}

model CustomField {
  id          String   @id @default(uuid())
  
  name        String
  fieldType   FieldType
  options     String[] // For SELECT/MULTISELECT
  required    Boolean  @default(false)
  
  entityType  String // 'case', 'task', 'client'
  
  firmId      String
  
  values      CustomFieldValue[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([firmId])
  @@index([entityType])
  @@map("custom_fields")
}

model CustomFieldValue {
  id          String   @id @default(uuid())
  
  fieldId     String
  field       CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  
  value       String
  
  caseId      String?
  case        Case?    @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([fieldId])
  @@index([caseId])
  @@map("custom_field_values")
}
